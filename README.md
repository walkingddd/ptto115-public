# PT文件转存115网盘工具

# ptto115
## 项目简介
ptto115是一个高效的PT文件转存工具，专为解决运营商对用户上传带宽限制问题而设计。工具通过调用115网盘的秒传接口，实现文件快速转存到115网盘，无需实际上传文件内容，从而避免占用宝贵的上传带宽资源。

工具会自动监控指定目录中的文件，尝试秒传至115网盘，对于秒传失败的文件会智能重试，并在达到最大尝试次数后自动将文件移动到指定目录，方便用户进行其他处理。


## 核心功能
1. **秒传机制**：优先调用115网盘秒传接口，直接基于文件哈希信息完成转存，无需实际上传文件内容
2. **智能重试**：当秒传失败时，自动休眠一段时间后重新尝试秒传，提高转存成功率
3. **带宽节省**：通过避免用户执行文件首传，显著减少对本地上传带宽的占用
4. **自动归档**：当文件尝试秒传达到最大次数后，自动将文件移动到指定的transfer目录，避免无限重试
5. **状态通知**：支持通过Telegram机器人发送任务状态通知，及时了解文件转存情况
6. **配置灵活**：支持通过环境变量自定义各项参数，适应不同使用场景


## 部署方法
使用Docker Compose快速部署，配置如下：

```yaml
version: '3'

services:
  p115client-service:
    image: walkingd/ptto115:latest  # 使用预构建镜像
    container_name: ptto115
    network_mode: host  # 使用主机网络模式，使容器直接使用宿主机网络栈
    environment:
      # 115网盘身份验证Cookies（需替换为实际值）
      - ENV_115_COOKIES=UID=; CID=; SEID=; KID=     
      # 115网盘目标目录ID（需替换为实际目录ID）
      - ENV_115_UPLOAD_PID=3205381019324771023     
      # HTTP请求代理配置
      - HTTP_PROXY=http://127.0.0.1:7890
      # HTTPS请求代理配置
      - HTTPS_PROXY=http://127.0.0.1:7890
      # TG机器人token（可选）
      - ENV_TG_BOT_TOKEN=
      # TG机器人用户ID（可选）
      - ENV_TG_ADMIN_USER_ID= 
      # 最大重试次数，超过重试次数后将文件移动到transfer目录
      - ENV_TRY_MAX_COUNT=9999999
    volumes:
      # 本地PT文件下载目录（左侧）映射到容器内监控目录（右侧）
      - /vol3/1000/Video/MoviePilot/transfer:/app/upload
      # 超过重试次数后文件移动的目标目录（对应CD2的上传目录）（左侧）映射到容器内transfer目录（右侧）
      - /vol1/1000/CloudNAS/CloudDrive/115云盘/Video/待归档影视/MP待归档影视:/app/transfer
    restart: always  # 容器退出时自动重启，保证服务持续运行
```


## 环境变量说明
| 环境变量名称 | 说明 | 默认值 |
|---------|-----|-----|
| `ENV_115_COOKIES` | 115网盘身份验证Cookies，需替换为实际值 | `ck1111` |
| `ENV_115_UPLOAD_PID` | 115网盘目标目录ID，需替换为实际值 | `0` |
| `ENV_TG_BOT_TOKEN` | Telegram机器人token，可选 | 空 |
| `ENV_TG_ADMIN_USER_ID` | Telegram机器人用户ID，可选 | `0` |
| `ENV_TRY_MAX_COUNT` | 文件最大尝试秒传次数，超过后移动到transfer目录 | `9999999` |
| `HTTP_PROXY` | HTTP代理地址 | 空 |
| `HTTPS_PROXY` | HTTPS代理地址 | 空 |

## 使用方法
1. 准备好115网盘的Cookies和目标目录ID
2. 根据实际情况修改Docker Compose配置文件中的环境变量和挂载目录
3. 使用`docker-compose up -d`命令启动服务
4. 将待转存的PT文件放入配置的监控目录
5. 工具会自动处理文件，并在Telegram中发送状态通知（如果配置了TG机器人）

## 工作流程
1. 监控指定目录中的文件
2. 检查文件大小稳定性，确保文件完整
3. 尝试秒传文件到115网盘
4. 秒传成功：删除本地文件
5. 秒传失败：记录尝试次数，休眠后重试
6. 达到最大尝试次数：将文件移动到transfer目录

## 注意事项
- 环境变量`ENV_115_COOKIES`需替换为用户本人的115网盘登录Cookies（获取方式：登录115网页版后，通过浏览器开发者工具获取）
- `ENV_115_UPLOAD_PID`需替换为115网盘中目标存储目录的ID（可通过115网页版进入目标目录，从URL中提取）
- 本地映射目录需包含待转存的PT文件，工具会自动监控该目录并处理文件转存
- 请确保transfer目录有足够的存储空间，以存放超过最大尝试次数的文件
- 建议根据网络环境和115网盘的响应情况，适当调整`ENV_TRY_MAX_COUNT`的值

## 常见问题
Q: 如何获取115网盘的Cookies？
A: 登录115网页版后，按F12打开开发者工具，切换到Network标签，刷新页面，找到任意请求的Cookie值。

Q: 如何获取115网盘的目录ID？
A: 登录115网页版，进入目标目录，URL中的`cid`参数值即为目录ID。

Q: 为什么文件会被移动到transfer目录？
A: 当文件尝试秒传次数超过`ENV_TRY_MAX_COUNT`设置的值时，会被移动到transfer目录。这通常表示该文件无法通过秒传方式转存，需要其他方式处理。